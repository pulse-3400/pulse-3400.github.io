---
priority: 0.6
title: Lab 2
excerpt: Analog Circuitry and FFT
categories: labs
background-image: lab2-cover.png

---

### Objective
The purpose of this lab is to add sensors to our robot and to make analog circuits and a digital filter to interface with the Arduino. The two sensors are a microphone circuit and an IR sensor. The microphone circuit will detect a 660 Hz whistle blow signifying the beginning of the maze mapping. The circuit with the IR sensor will capture inputs from the sensor to detect nearby robots emitting IR at 6.08 kHz and distinguish them from decoys emitting IR at 18 kHz.

### Procedure
We split up into two teams, the acoustic team and the optic team, and progressed through the lab as follows:

#### Materials Used
The acoustic team used the following materials:
* 1 Arduino Uno
* Electret microphone
* 1 µF capacitor
* 300 Ω resistors
* ~3 kΩ resistor
* Various other components, as needed

The optical team used the following materials:
* 1 Arduino Uno
* IR transistor (OP598)
* 1 IR hat
* 1 IR decoy
* Various other components, as needed

### Acoustic Team 
#### Assembling the Microphone
Our first step was assembling the basic microphone circuit on the lab 2. The output of the circuit went to analog input A0. Our circuit was assembled according to the lab instructions:

<p align="center">
  <img src="/images/lab2_acousticbasic.jpg" width="560px" height="394px"/><br/>
        <i>Microphone circuit schematic.</i>
</p>
<p align="center">
  <img src="/images/lab2_fig1.png" width="394px" height="360px"/><br/>
      <i>Microphone circuit diagram. Source: <a href="https://cei-lab.github.io/ece3400-2018/lab2.html">here</a></i>
</p>

Next, we added the Open Music Lab FFT library to our Arduino IDE. We then the example script fft_adc_serial. In short, fft_adc_serial processes the signal into pin A0 using an FFT and sends it over the serial port.

The FFT algorithm samples a signal over a period of time and divides the signal into its frequency components. In this case, the signal is range of voltages into analog pin A0. Below is the graph when we generated a 660 Hz tone using an iPhone app into the microphone circuit. 

<p align="center">
  <img src="/images/lab2_660noamp.png" width="700px" height="394px"/><br/>
      <i>FFT output when playing 660 Hz. Peak in bin 5, other peaks likely due to surrounding lab noise.</i>
</p>

We decided that we wanted to amplify the signal so it would be readable. We added a filter and an op-amp (LF 353) to produce a gain of **gain**.

**gain calculation**.

<p align="center">
  <img src="/images/lab2_acousticamp.jpg" width="500px" height="394px"/><br/>
      <i>Microphone circuit schematic with amplifier.</i>
</p>

We first tested our amplifier using the function generator to input a 660 Hz frequency to ensure we got a gain (compared to the circuit without the amplifier), then reassembled the circuit to include the microphone.

<p align="center">
  <img src="/images/lab2_micamp.jpg" width="500px" height="394px"/><br/>
      <i>Completed amplified circuit with microphone.</i>
</p>

<p align="center">
  <img src="/images/lab2_noampvsamp.png" width="700px" height="394px"/><br/>
      <i>Reading output of a 660 Hz frequency (from the function generator) of our circuit, with and without our built amplifier.</i>
</p>

After ensuring the output signal of our circuit could be read by the ADC with an amplifier in place, we ran the *fft_adc_serial* script. To generate the correct frequency, we used an iPhone app that played a 660 Hz tone. We plotted the FFT of a 660 Hz generated tone into the microphone, and the FFT of no tone into the microphone and found the following results:

<p align="center">
  <img src="/images/lab2_withamp.png" width="700px" height="394px"/><br/>
      <i>FFT on the signal of our acoustic circuit, with 660 Hz and no tone as input frequencies.</i>
</p>

Despite the fact that there was talking in the background when we plotted our "no tone" frequency, there is clearly a difference in the output in bin 5. Thus, we're able to find a threshold value to distinguish the 660 Hz tone from the "no tone." We picked 110 (based on our FFT plots) as our threshold. In our fft_adc_serial, we added the following logic to turn on the LED when the 660 Hz tone was picked up by the microphone.

```
void loop() {

  while(1) {
    ...
    for (int i = 0 ; i < 512 ; i += 2) {
      ... // put data in bins
    } 
    ... // process data
    
    /* Distinguishable tone logic:
     * Based on our FFT plots, if value is >= 110 in bin 5, a 660Hz tone is heard.
     * 110 is our threshold value for background noise.
     */
     
    if (fft_log_out[5] >= 110) {
      digitalWrite(LED_BUILTIN, HIGH);
    }
    else {
      digitalWrite(LED_BUILTIN, LOW);
    }
  }
  
```

<p align="center">
  <img src="/images/lab2_iPhoneapp.png" width="650px" height="394px"/><br/>
      <i><b>A video demonstration of our working circuit and code can be found <a href=""> here </a></b>
</i>
</p>


### IR Team



